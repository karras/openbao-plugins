# OpenBao Plugin: Google Cloud Platform Auth Backend

This is a standalone backend plugin for use with [OpenBao](https://www.github.com/openbao/openbao).
This plugin allows for various GCP entities to authenticate with OpenBao.
This is currently included in OpenBao distributions.

Currently, this plugin supports login for:

- IAM service accounts
- GCE Instances


## Getting Started

This is an [OpenBao plugin](https://openbao.org/docs/plugins/)
and is meant to work with OpenBao. This guide assumes you have already installed Openbao
and have a basic understanding of how OpenBao works.

Otherwise, first read this guide on how to [get started with
OpenBao](https://openbao.org/docs/get-started/developer-qs/).

To learn specifically about how plugins work, see documentation on [OpenBao plugins](https://openbao.org/docs/plugins/).

### Usage

Please see [documentation for the plugin](./docs/index.md) in this repository.

## Developing

If you wish to work on this plugin, you'll first need
[Go](https://www.golang.org) installed on your machine (version 1.10+ is
*required*).

For local dev first make sure Go is properly installed, including
setting up a [GOPATH](https://golang.org/doc/code.html#GOPATH).
Next, clone this repository into your `GOPATH`:

### Build Plugin

If you're developing for the first time, run `make bootstrap` to install the
necessary tools. Bootstrap will also update repository name references if that
has not been performed ever before.

   ```sh
   $ make bootstrap
   ```

To compile a development version of this plugin, run `make` or `make dev`.
This will put the plugin binary in the `bin` and `$GOPATH/bin` folders. `dev`
mode will only generate the binary for your platform and is faster:

   ```sh
   $ make
   $ make dev
   ```

### Start OpenBao

1. For local development, use OpenBao's "dev" mode for fast setup:

   ```sh
   $ bao server -dev -dev-root-token-id=root -dev-plugin-dir="$GOPATH/openbao-plugins"
   ```

### Set Up Plugin in OpenBao

Next you want OpenBao to use the newly built binary instead of the version bundled with Openbao.
You can use the scripted or manual methods depending on your preference.

Scripted method.

1. A Terraform project sets up the necessary gcp service account & credentials.
   You can configure the project id via this environment variable: `TF_VAR_GOOGLE_CLOUD_PROJECT_ID`
   or paste it in the terminal when prompted.

    ```sh
    $ make setup-env
    ```

2. Source the environment variables generated by the setup project:

    ```sh
    $ source ./bootstrap/terraform/local_environment_setup.sh
    ```

3. Enable the dev version of the plugin on your local OpenBao instance. You can specify the plugin name,
   development [`plugin_directory`](https://openbao.org/docs/configuration/#parameters)
   and mount path or leave empty to use the default values.

    ```sh
    $ make configure PLUGIN_NAME=openbao-plugin-auth-gcp PLUGIN_DIR=$GOPATH/openbao-plugins PLUGIN_PATH=gcp
    ```

Manual method.

1. Save the name of your project as an environment variable for reference:

    ```sh
    $ export GOOGLE_CLOUD_PROJECT=my-project # replace with your project ID
    ```
The remaining steps may also be executed by running `. scripts/cred_setup.sh`.

1. Enable the IAM service on the project:

    ```sh
    $ gcloud services enable --project "${GOOGLE_CLOUD_PROJECT}" \
        cloudresourcemanager.googleapis.com \
        iam.googleapis.com
    ```

1. Create the service account:

    ```sh
    $ gcloud iam service-accounts create openbao-tester \
        --display-name openbao-tester \
        --project "${GOOGLE_CLOUD_PROJECT}"
    ```

1. Grant `project.viewer` and `serviceaccount.admin` permissions:

    ```sh
    $ gcloud projects add-iam-policy-binding "${GOOGLE_CLOUD_PROJECT}" \
        --member "serviceAccount:openbao-tester@${GOOGLE_CLOUD_PROJECT}.iam.gserviceaccount.com" \
        --role "roles/viewer"

    $ gcloud projects add-iam-policy-binding "${GOOGLE_CLOUD_PROJECT}" \
        --member "serviceAccount:openbao-tester@${GOOGLE_CLOUD_PROJECT}.iam.gserviceaccount.com" \
        --role "roles/iam.serviceAccountKeyAdmin"

    $ gcloud projects add-iam-policy-binding "${GOOGLE_CLOUD_PROJECT}" \
        --member "serviceAccount:openbao-tester@${GOOGLE_CLOUD_PROJECT}.iam.gserviceaccount.com" \
        --role "roles/iam.serviceAccountTokenCreator"
    ```

1. Download the service account key file to local disk:

    ```sh
    $ gcloud iam service-accounts keys create openbao-tester.json \
        --iam-account "openbao-tester@${GOOGLE_CLOUD_PROJECT}.iam.gserviceaccount.com"
    ```

1. Export the credentials to an environment variable:

    ```sh
    $ export GOOGLE_TEST_CREDENTIALS="$(cat openbao-tester.json)"
    ```

#### Tests

This plugin has comprehensive [acceptance tests](https://en.wikipedia.org/wiki/Acceptance_testing)
covering most of the features of this auth backend.

If you are developing this plugin and want to verify it is still
functioning (and you haven't broken anything else), we recommend
running the acceptance tests.

Acceptance tests typically require other environment variables to be set for
things such as access keys. The test itself should error early and tell
you what to set, so it is not documented here.

**Warning:** The acceptance tests create/destroy/modify *real resources*,
which may incur real costs in some cases. In the presence of a bug,
it is technically possible that broken backends could leave dangling
data behind. Therefore, please run the acceptance tests at your own risk.
At the very least, we recommend running them in their own private
account for whatever backend you're testing.

To run the acceptance tests, you will need a GCP IAM service account with the
appropriate permissions. You can use the steps explained in the [setup section](#set-up-plugin-in-openbao) to configure one for you.

1. Save the name of your test project as an environment variable for reference:

    ```sh
    $ export GOOGLE_CLOUD_PROJECT_ID=my-project # replace with your project ID
    ```

1. Run the acceptance tests:

    ```sh
    $ make testacc
    ```

Note that it may take some time (e.g. over a minute) for the new credentials to work.

[install-gcloud]: https://cloud.google.com/sdk
