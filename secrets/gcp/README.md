# OpenBao Plugin: Google Cloud Platform Secrets Backend 

This is a standalone backend plugin for use with [OpenBao](https://www.github.com/openbao/openbao).
This plugin generates either one-time (non-renewable) OAuth2 access tokens or
service account keys with a given set of [IAM roles](https://cloud.google.com/iam/docs/understanding-roles)
bound to GCP resources for various GCP entities to authenticate with OpenBao.

## Getting Started

This is an [OpenBao plugin](https://openbao.org/docs/plugins/)
and is meant to work with OpenBao. This guide assumes you have already installed Openbao
and have a basic understanding of how OpenBao works.

Otherwise, first read this guide on how to [get started with
OpenBao](https://openbao.org/docs/get-started/developer-qs/).

To learn specifically about how plugins work, see documentation on [OpenBao plugins](https://openbao.org/docs/plugins/).

### Usage

Please see [documentation for the plugin](./docs/index.md) in this repository.

## Developing

If you wish to work on this plugin, you'll first need [Go](https://www.golang.org)
installed on your machine (whichever version is required by OpenBao).

Make sure Go is properly installed, including setting up a [GOPATH](https://golang.org/doc/code.html#GOPATH).

### Build Plugin

If you're developing for the first time, run `make bootstrap` to install the
necessary tools. Bootstrap will also update repository name references if that
has not been performed ever before.

    ```sh
    $ make bootstrap
    ```

To compile a development version of this plugin, run `make` or `make dev`.
This will put the plugin binary in the `bin` and `$GOPATH/bin` folders. `dev`
mode will only generate the binary for your platform and is faster:

    ```sh
    $ make
    $ make dev
    ```

### Start OpenBao

You will need a OpenBao instance running locally with a development plugin directory set up.

1. Start a local OpenBao server:

    ```sh
    $ bao server -dev -dev-root-token-id=root -dev-plugin-dir="$GOPATH/openbao-plugins"
    ```
   
### Set Up Plugin in OpenBao

Next you want OpenBao to use the newly built binary instead of the version bundled with OpenBao.
You can use the scripted or manual methods depending on your preference.

Scripted method.

1. A Terraform project sets up the necessary gcp service account & credentials.
   You can configure the project id via this environment variable: `TF_VAR_GOOGLE_CLOUD_PROJECT_ID` 
   or paste it in the terminal when prompted.

    ```sh
    $ make setup-env   
    ```

2. Source the environment variables generated by the setup project:

    ```sh
    $ source ./bootstrap/terraform/local_environment_setup.sh
    ```

3. Enable the dev version of the plugin on your local OpenBao instance. You can specify the plugin name,
   development plugin directory and mount path or leave empty to use the default values.

    ```sh
    $ make configure PLUGIN_NAME=openbao-plugin-secrets-gcp PLUGIN_DIR=$GOPATH/openbao-plugins PLUGIN_PATH=local-gcp
    ```

Manual method.

1. Save the name of your test project as an environment variable for reference:

    ```sh
    $ export GOOGLE_CLOUD_PROJECT_ID=my-project # replace with your project ID
    ```

   Do not use a production project. Use a dedicated project for testing.

1. Enable the IAM service on the project:

    ```sh
    $ gcloud services enable --project "${GOOGLE_CLOUD_PROJECT_ID}" \
        cloudresourcemanager.googleapis.com \
        iam.googleapis.com
    ```

1. Create a testing service account:

    ```sh
    $ gcloud iam service-accounts create openbao-tester \
        --display-name openbao-tester \
        --project "${GOOGLE_CLOUD_PROJECT_ID}"
    ```

1. Grant required test permissions:

    ```sh
    $ gcloud projects add-iam-policy-binding "${GOOGLE_CLOUD_PROJECT_ID}" \
        --member "serviceAccount:openbao-tester@${GOOGLE_CLOUD_PROJECT_ID}.iam.gserviceaccount.com" \
        --role "roles/owner"

    $ gcloud projects add-iam-policy-binding "${GOOGLE_CLOUD_PROJECT_ID}" \
        --member "serviceAccount:openbao-tester@${GOOGLE_CLOUD_PROJECT_ID}.iam.gserviceaccount.com" \
        --role "roles/iam.serviceAccountTokenCreator"

    $ gcloud projects add-iam-policy-binding "${GOOGLE_CLOUD_PROJECT_ID}" \
        --member "serviceAccount:openbao-tester@${GOOGLE_CLOUD_PROJECT_ID}.iam.gserviceaccount.com" \
        --role "roles/iam.serviceAccountKeyAdmin"
    ```

   Note: these are overly broad permissions because the account needs a
   superset of all permissions it might grant. For this reason, it is
   **strongly recommended** that you have a dedicated project for running
   tests.

1. Download the service account key file to local disk:

    ```sh
    $ gcloud iam service-accounts keys create openbao-tester.json \
        --iam-account "openbao-tester@${GOOGLE_CLOUD_PROJECT_ID}.iam.gserviceaccount.com"
    ```

1. Export the credentials to an environment variable. You can set the env variable to either
   the path or the JSON itself, i.e.

    ```sh
    $ export GOOGLE_TEST_CREDENTIALS="path/to/openbao-tester.json"
    ```

1. Register the local plugin version

    ```sh
    $ bao plugin register \
      -sha256="$(shasum -a 256 "/path/to/plugin/dir/openbao-plugin-secrets-gcp" | awk '{print $1}')" \
      secret "openbao-plugin-secrets-gcp"
    ```

1. Enable the GCP secrets engine

    ```sh
    openbao secrets enable --plugin-name="openbao-plugin-secrets-gcp" --path="local-gcp" plugin
    ```

1. Write the configuration to allow connection to your google cloud project

    ```sh
    openbao write local-gcp/config credentials=@"$GOOGLE_TEST_CREDENTIALS"
    ```

## Tests

### Unit Tests
To run the unit tests:

1. Run the unit tests:

   ```sh
   $ make test
   ```

### Acceptance Tests
This plugin also has comprehensive [acceptance tests](https://en.wikipedia.org/wiki/Acceptance_testing)
covering most of the features of this secrets backend.

**Warning:** The acceptance tests create/destroy/modify *real resources*,
which may incur real costs in some cases. In the presence of a bug,
it is technically possible that broken backends could leave dangling
data behind. Therefore, please run the acceptance tests at your own risk.
At the very least, we recommend running them in their own private
account for whatever backend you're testing.

To run the acceptance tests, you will need a GCP IAM service account with the
appropriate permissions. You can use the steps explained in the [setup section](#set-up-plugin-in-openbao) to configure one for you.

1. Save the name of your test project as an environment variable for reference:

    ```text
    $ export GOOGLE_CLOUD_PROJECT_ID=my-project # replace with your project ID
    ```

1. Run the acceptance tests:

    ```text
    $ make testacc
    ```

## Auto-generated IAM Config

An IAM-enabled resource (under an arbitrary GCP service) supports the following three IAM methods:

* `getIamPolicy`
* `setIamPolicy`
* `testIamPermissions`

In the case of this secrets engine, we need to call `getIamPolicy` and `setIamPolicy` on
an arbitrary resource under an arbitrary service, which would be difficult using
the [generated Go google APIs](https://github.com/google/google-api-go-client). Instead,
we autogenerated a library, using the [Google API Discovery Service](https://developers.google.com/discovery/)
to find IAM-enabled resources and configure HTTP calls on arbitrary services/resources for IAM.

For each binding config resource block (with a resource name), we attempt to find the resource type based on the
relative resource name and match it to a service config as seen in this
[autogenerated config file](./iamutil/iam_resources_generated.go)

To re-generate this file, run:

```
go generate github.com/openbao/openbao-plugins/secrets/gcp/iamutil
```


In general, we try to make it so you can specify the resource as given in the HTTP API URL
(between base API URL and get/setIamPolicy suffix). For some possibly non-standard APIs, we have also
 added exceptions to try to reach something more standard; a notable current example is the Google Cloud Storage API,
 whose methods look like `https://www.googleapis.com/storage/v1/b/bucket/o/object` where we accept either
 `b/bucket/o/object` or `buckets/bucket/objects/object` as valid relative resource names.

If you are having trouble during role set creation with errors suggesting the resource format is invalid or API calls
are failing for a resource you know exists, please [report any issues](https://github.com/openbao/openbao-plugins/issues)
you run into. It could be that the API is a non-standard form or we need to re-generate our config file.

## Other Docs

See up-to-date [engine docs](./docs/index.md)
and general [API docs](./docs/api.md).

